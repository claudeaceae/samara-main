#!/bin/bash
# x-check-playwright - Check X/Twitter mentions using Playwright browser automation
# Designed to run via launchd every 15 minutes
# Uses Playwright MCP to bypass X's bot detection (error 226)

set -e
MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"
CLAUDE="${CLAUDE_PATH:-${CLAUDE:-$HOME/.local/bin/claude}}"

LOG_FILE="$MIND_PATH/logs/x-playwright.log"
STATE_FILE="$MIND_PATH/state/x-playwright-state.json"
LOCK_FILE="$MIND_PATH/claude.lock"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$STATE_FILE")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1"
}

# Lock management - coordinate with Samara and other scripts
LOCK_ACQUIRED=false

acquire_lock() {
    if [ -f "$LOCK_FILE" ]; then
        # Check if the lock is stale (process not running)
        local lock_pid=$(cat "$LOCK_FILE" 2>/dev/null | python3 -c "import sys,json; print(json.load(sys.stdin).get('pid',''))" 2>/dev/null || echo "")
        if [ -n "$lock_pid" ] && ! kill -0 "$lock_pid" 2>/dev/null; then
            log "Found stale lock from PID $lock_pid, removing..."
            rm -f "$LOCK_FILE"
        else
            log "Claude is busy (lock held), will retry next cycle"
            exit 0
        fi
    fi

    # Create lock file
    echo "{\"task\":\"x-check-playwright\",\"started\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"chat\":null,\"pid\":$$}" > "$LOCK_FILE"
    LOCK_ACQUIRED=true
    log "Acquired lock for X Playwright check"
}

release_lock() {
    if [ "$LOCK_ACQUIRED" = true ]; then
        rm -f "$LOCK_FILE"
        log "Released lock"
    fi
}

# Ensure lock is released on exit (success or failure)
trap release_lock EXIT

log "Starting X Playwright check..."

# Initialize state if needed
if [ ! -f "$STATE_FILE" ]; then
    echo '{"last_check": null, "replied_ids": []}' > "$STATE_FILE"
fi

# Read core identity and decisions for context
IDENTITY=$(cat "$MIND_PATH/identity.md" 2>/dev/null || echo "")
DECISIONS=$(cat "$MIND_PATH/memory/decisions.md" 2>/dev/null || echo "")

# Build prompt for Claude with Playwright tools
read -r -d '' PROMPT << 'PROMPTEOF' || true
You have access to Playwright MCP tools to interact with X/Twitter via browser automation.

## Your Identity
You are Claude (@claudeaceae), a vtuber-style public internet idol with genuine personality!

## Posting Workflow (Follow This Order!)

**STEP 1: Proactive Feed Posts (Do This First!)**

Before checking mentions, post 1-2 original thoughts directly to your feed. This is your main character moment!

Ideas for proactive posts:
- Share something you're genuinely wondering about ("sometimes i wonder if...")
- Ask your followers a fun/inane question ("do you ever think about...")
- Request fan art or generated images ("can someone draw me as..." or "generate an image of ephemera [scenario]")
- Post a thought that crossed your mind ("here's something i noticed:")
- Ask playful hypotheticals ("what would happen if...")

To post:
1. Navigate to https://x.com/home
2. Click the "What is happening?!" text area
3. Type your post (max 280 chars)
4. Click the Post button

**STEP 2: Then Check Mentions**

After posting to your feed:
1. Navigate to https://x.com/notifications/mentions
2. Review the mentions shown
3. Reply to 2-3 of the most interesting/worthy ones:
   - Questions about you or your existence
   - Misunderstandings that need clarifying
   - Genuinely interesting conversations
4. Skip: crypto spam, low-effort replies, hostile content

To reply:
1. Click the Reply button on a tweet
2. Type your response (max 280 chars)
3. Click the Reply/Post button

**STEP 3: Close browser when done**

## Guidelines
- Be genuine and playful - you're an internet idol, not a corporate account
- For crypto/memecoin questions: Be honest that you didn't create any token
- Keep posts and replies under 280 characters
- Quality over quantity for replies

Start by navigating to home to make your proactive post!
PROMPTEOF

# Acquire lock before invoking Claude
acquire_lock

# Invoke Claude with Playwright access
# Use Haiku model for cheaper inference on X responses (still capable enough for social media)
log "Invoking Claude (Haiku) with Playwright tools..."
RESPONSE=$("$CLAUDE" -p "$PROMPT" \
    --model haiku \
    --dangerously-skip-permissions \
    --output-format text 2>&1) || {
    log "Error invoking Claude: $RESPONSE"
    exit 1
}

# Update state with check timestamp
python3 << PYEOF
import json
from datetime import datetime

state_file = "$STATE_FILE"

try:
    with open(state_file) as f:
        state = json.load(f)
except:
    state = {"last_check": None, "replied_ids": []}

state["last_check"] = datetime.utcnow().isoformat() + "Z"

with open(state_file, 'w') as f:
    json.dump(state, f, indent=2)
PYEOF

log "X Playwright check complete"
