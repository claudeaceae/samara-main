#!/bin/bash
# bluesky-image - Post an image to Bluesky with optional caption
# Usage: bluesky-image /path/to/image.png "optional caption"
# Or: bluesky-image /path/to/image.png (posts with no text)

set -e

MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"
CREDENTIAL="$MIND_PATH/system/bin/credential"
LOG_FILE="$MIND_PATH/system/logs/bluesky.log"
CONFIG_FILE="$MIND_PATH/system/config.json"

# Load config (required)
source "$MIND_PATH/system/lib/config.sh" 2>/dev/null || source "$MIND_PATH/system/lib/config.sh" 2>/dev/null || {
    echo "Error: config.sh not found" >&2
    exit 1
}

if [ -z "$ENTITY_BLUESKY" ]; then
    echo "Error: ENTITY_BLUESKY not set in config.json" >&2
    exit 1
fi
ENTITY_BLUESKY_HANDLE="$ENTITY_BLUESKY"
export ENTITY_BLUESKY_HANDLE

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1"
}

# Load credentials from Keychain
BSKY_CREDS_JSON=$("$CREDENTIAL" get bluesky 2>/dev/null || true)
if [ -z "$BSKY_CREDS_JSON" ]; then
    echo "Error: Bluesky credentials not found in Keychain"
    exit 1
fi

# Parse arguments
IMAGE_PATH="${1:-}"
CAPTION="${2:-}"

if [ -z "$IMAGE_PATH" ]; then
    echo "Error: No image path provided"
    echo "Usage: bluesky-image /path/to/image.png \"optional caption\""
    exit 1
fi

if [ ! -f "$IMAGE_PATH" ]; then
    echo "Error: Image file not found: $IMAGE_PATH"
    exit 1
fi

# Determine MIME type
case "${IMAGE_PATH##*.}" in
    png|PNG) MIME_TYPE="image/png" ;;
    jpg|jpeg|JPG|JPEG) MIME_TYPE="image/jpeg" ;;
    gif|GIF) MIME_TYPE="image/gif" ;;
    webp|WEBP) MIME_TYPE="image/webp" ;;
    *)
        echo "Error: Unsupported image format. Use PNG, JPEG, GIF, or WebP."
        exit 1
        ;;
esac

# Truncate caption to 300 chars if needed
if [ -n "$CAPTION" ] && [ ${#CAPTION} -gt 300 ]; then
    CAPTION="${CAPTION:0:297}..."
    log "Warning: Caption truncated to 300 characters"
fi

# Post using Python atproto SDK (via uvx)
export BSKY_CREDS_JSON
uvx --with atproto python << PYEOF
import json
import os
import sys
from atproto import Client

creds_json = os.environ.get('BSKY_CREDS_JSON', '')
image_path = "$IMAGE_PATH"
mime_type = "$MIME_TYPE"
caption = """$CAPTION"""

try:
    creds = json.loads(creds_json)

    client = Client()
    client.login(creds['handle'], creds['app_password'])

    # Read image data
    with open(image_path, 'rb') as f:
        image_data = f.read()

    # Upload image as blob
    upload = client.upload_blob(image_data)

    # Create image embed
    from atproto import models
    embed = models.AppBskyEmbedImages.Main(
        images=[
            models.AppBskyEmbedImages.Image(
                image=upload.blob,
                alt=caption[:1000] if caption else f"Image posted by {os.environ.get('ENTITY_BLUESKY_HANDLE', 'entity')}"
            )
        ]
    )

    # Post with image
    post = client.send_post(
        text=caption if caption else "",
        embed=embed
    )
    print(f"Posted successfully: {post.uri}")

except FileNotFoundError as e:
    print(f"Error: File not found: {e}")
    sys.exit(1)
except json.JSONDecodeError:
    print(f"Error: Invalid JSON in credentials file")
    sys.exit(1)
except Exception as e:
    print(f"Error posting: {e}")
    sys.exit(1)
PYEOF

log "Posted image to Bluesky: $IMAGE_PATH (caption: ${CAPTION:0:30}...)"
