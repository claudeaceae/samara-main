#!/bin/bash
# bluesky-post - Post to Bluesky
# Usage: bluesky-post "text to post"
# Or: echo "text" | bluesky-post

set -e

MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"
CREDS_FILE="$MIND_PATH/credentials/bluesky.json"
LOG_FILE="$MIND_PATH/logs/bluesky.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    echo "$1"
}

# Check credentials exist
if [ ! -f "$CREDS_FILE" ]; then
    echo "Error: Credentials not found at $CREDS_FILE"
    echo "Create a JSON file with: {\"handle\": \"your.handle\", \"app_password\": \"xxxx-xxxx-xxxx-xxxx\"}"
    exit 1
fi

# Get text from argument or stdin
TEXT="${1:-$(cat)}"

if [ -z "$TEXT" ]; then
    echo "Error: No text provided"
    echo "Usage: bluesky-post \"text to post\""
    exit 1
fi

# Validate input - reject flag-like arguments and internal commands
# This catches cases where Claude outputs commands instead of content
if [[ "$TEXT" == --* ]]; then
    echo "Error: Text looks like a command flag (starts with --)"
    echo "bluesky-post does not support flags. For replies, use the atproto Python SDK."
    echo "For images, use bluesky-image script instead."
    exit 1
fi

# Reject common internal/debug messages that shouldn't be posted
INTERNAL_PATTERNS=(
    "^update.*timestamp"
    "^checking.*status"
    "^processing.*event"
    "^sending.*to"
    "^waiting for"
)
for pattern in "${INTERNAL_PATTERNS[@]}"; do
    if echo "$TEXT" | grep -iqE "$pattern"; then
        echo "Error: Text looks like an internal message, not a post"
        echo "Rejected: $TEXT"
        exit 1
    fi
done

# Post using Python atproto SDK (via uvx)
uvx --with atproto python << PYEOF
import json
import sys
from atproto import Client

creds_file = "$CREDS_FILE"
text = """$TEXT"""

try:
    with open(creds_file) as f:
        creds = json.load(f)

    client = Client()
    client.login(creds['handle'], creds['app_password'])

    # Post (truncate to 300 chars if needed - Bluesky limit is actually 300 graphemes)
    if len(text) > 300:
        text = text[:297] + "..."

    post = client.send_post(text)
    print(f"Posted successfully: {post.uri}")

except FileNotFoundError:
    print(f"Error: Credentials file not found: {creds_file}")
    sys.exit(1)
except json.JSONDecodeError:
    print(f"Error: Invalid JSON in credentials file")
    sys.exit(1)
except Exception as e:
    print(f"Error posting: {e}")
    sys.exit(1)
PYEOF

log "Posted to Bluesky: ${TEXT:0:50}..."
