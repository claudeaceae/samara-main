#!/bin/bash
# Updates Samara via proper Archive+Export workflow with Developer ID signing + notarization
# This should preserve FDA across rebuilds since notarized apps get stable TCC treatment
#
# Usage: update-samara [samara-dir]
#
# If no directory specified, looks for Samara in:
#   1. $SAMARA_DIR environment variable
#   2. ~/Developer/Samara (legacy location)
#   3. Relative to this script's repo (../Samara)

set -e

# Find Samara directory
find_samara_dir() {
    # Check environment variable
    if [ -n "$SAMARA_DIR" ] && [ -d "$SAMARA_DIR" ]; then
        echo "$SAMARA_DIR"
        return
    fi

    # Check legacy location
    if [ -d "$HOME/Developer/Samara" ]; then
        echo "$HOME/Developer/Samara"
        return
    fi

    # Check relative to script (for repo-based setup)
    local script_dir="$(cd "$(dirname "$0")" && pwd)"
    local repo_samara="$(dirname "$script_dir")/Samara"
    if [ -d "$repo_samara" ]; then
        echo "$repo_samara"
        return
    fi

    echo ""
}

SAMARA_DIR="${1:-$(find_samara_dir)}"

if [ -z "$SAMARA_DIR" ] || [ ! -d "$SAMARA_DIR" ]; then
    echo "Error: Cannot find Samara directory"
    echo "Usage: update-samara [samara-dir]"
    echo ""
    echo "Or set SAMARA_DIR environment variable"
    exit 1
fi

echo "Using Samara directory: $SAMARA_DIR"

ARCHIVE_PATH="/tmp/Samara.xcarchive"
EXPORT_PATH="/tmp/SamaraExport"
EXPORT_OPTIONS="$SAMARA_DIR/ExportOptions.plist"
NOTARY_PROFILE="notarytool-samara"

# Check for ExportOptions.plist
if [ ! -f "$EXPORT_OPTIONS" ]; then
    echo "Error: ExportOptions.plist not found at $EXPORT_OPTIONS"
    echo ""
    echo "Create ExportOptions.plist with your Team ID:"
    echo '<?xml version="1.0" encoding="UTF-8"?>'
    echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">'
    echo '<plist version="1.0">'
    echo '<dict>'
    echo '    <key>method</key>'
    echo '    <string>developer-id</string>'
    echo '    <key>teamID</key>'
    echo '    <string>G4XVD3J52J</string>  <!-- Replace with your Team ID -->'
    echo '</dict>'
    echo '</plist>'
    exit 1
fi

echo "ðŸ”¨ Building Samara with Developer ID signing..."

# Stop running Samara
echo "â¹ï¸  Stopping existing Samara..."
pkill -9 -f "Samara.app" 2>/dev/null || true
sleep 1

# Clean old archive/export
rm -rf "$ARCHIVE_PATH" "$EXPORT_PATH"

# Archive
echo "ðŸ“¦ Archiving..."
cd "$SAMARA_DIR"
xcodebuild -scheme Samara -configuration Release -archivePath "$ARCHIVE_PATH" archive -quiet

# Export
echo "ðŸ“¤ Exporting with Developer ID..."
xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportPath "$EXPORT_PATH" -exportOptionsPlist "$EXPORT_OPTIONS" -quiet

# Create zip for notarization
echo "ðŸ“‹ Preparing for notarization..."
cd "$EXPORT_PATH"
/usr/bin/ditto -c -k --keepParent "Samara.app" "Samara.zip"

# Submit for notarization
echo "ðŸ” Submitting for notarization (this may take a few minutes)..."
if ! xcrun notarytool submit "Samara.zip" --keychain-profile "$NOTARY_PROFILE" --wait; then
    echo ""
    echo "âš ï¸  Notarization failed. You may need to set up notarytool credentials:"
    echo "   xcrun notarytool store-credentials notarytool-samara --apple-id YOUR_APPLE_ID --team-id YOUR_TEAM_ID"
    echo ""
    echo "Continuing with non-notarized build (FDA may not persist)..."
fi

# Staple the ticket to the app (if notarization succeeded)
echo "ðŸ“Ž Stapling notarization ticket..."
xcrun stapler staple "Samara.app" 2>/dev/null || true

# Install
echo "ðŸ“² Installing to /Applications..."
rm -rf /Applications/Samara.app
cp -R "Samara.app" /Applications/

# Launch
echo "ðŸš€ Launching Samara..."
open /Applications/Samara.app

echo ""
echo "âœ… Samara updated successfully!"
echo ""
