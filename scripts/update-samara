#!/bin/bash
# Updates Samara via proper Archive+Export workflow with Developer ID signing + notarization
# This should preserve FDA across rebuilds since notarized apps get stable TCC treatment

set -e

if [[ -n "${SAMARA_TEST_MODE:-}" ]]; then
    echo "Refusing to run update-samara in SAMARA_TEST_MODE" >&2
    exit 1
fi

# Determine repo path dynamically
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# If in symlinked bin dir, follow the symlink to find repo
if [ -L "$SCRIPT_DIR/../$(basename "$0")" ] || [ -L "${BASH_SOURCE[0]}" ]; then
    # Script is symlinked, resolve to actual repo location
    REAL_SCRIPT="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || readlink "${BASH_SOURCE[0]}")"
    SCRIPT_DIR="$(dirname "$REAL_SCRIPT")"
fi
REPO_DIR="$(dirname "$SCRIPT_DIR")"
SAMARA_DIR="$REPO_DIR/Samara"
ARCHIVE_PATH="/tmp/Samara.xcarchive"
EXPORT_PATH="/tmp/SamaraExport"
EXPORT_OPTIONS="/tmp/ExportOptions.plist"
NOTARY_PROFILE="notarytool-samara"

echo "üî® Building Samara with Developer ID signing..."

# Create export options for Developer ID
cat > "$EXPORT_OPTIONS" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>teamID</key>
    <string>G4XVD3J52J</string>
    <key>signingStyle</key>
    <string>manual</string>
    <key>signingCertificate</key>
    <string>Developer ID Application</string>
</dict>
</plist>
EOF

# Unload launchd agent first to prevent KeepAlive from restarting Samara
# before the new binary is installed
echo "‚èπÔ∏è  Unloading launchd agent..."
launchctl unload ~/Library/LaunchAgents/co.organelle.Samara.plist 2>/dev/null || true
sleep 1

# Stop running Samara with graceful shutdown attempt first
echo "‚èπÔ∏è  Stopping existing Samara..."
# Try graceful termination first (SIGTERM)
pkill -15 -f "Samara.app" 2>/dev/null || true
sleep 2

# If still running, force kill
if pgrep -f "Samara.app" > /dev/null 2>&1; then
    echo "   Force killing..."
    pkill -9 -f "Samara.app" 2>/dev/null || true
    sleep 1
fi

# Wait until completely dead
for i in {1..10}; do
    if ! pgrep -f "Samara.app" > /dev/null 2>&1; then
        break
    fi
    echo "   Waiting for Samara to exit... ($i)"
    sleep 1
done

# Final check
if pgrep -f "Samara.app" > /dev/null 2>&1; then
    echo "‚ùå Failed to stop Samara. Aborting."
    exit 1
fi

echo "   Samara stopped."

# Clean old archive/export
rm -rf "$ARCHIVE_PATH" "$EXPORT_PATH"

# Archive
echo "üì¶ Archiving..."
cd "$SAMARA_DIR"
xcodebuild -scheme Samara -configuration Release -archivePath "$ARCHIVE_PATH" archive -quiet

# Export
echo "üì§ Exporting with Developer ID..."
xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportPath "$EXPORT_PATH" -exportOptionsPlist "$EXPORT_OPTIONS" -quiet

# Create zip for notarization
echo "üìã Preparing for notarization..."
cd "$EXPORT_PATH"
/usr/bin/ditto -c -k --keepParent "Samara.app" "Samara.zip"

# Submit for notarization
echo "üîè Submitting for notarization (this may take a few minutes)..."
xcrun notarytool submit "Samara.zip" --keychain-profile "$NOTARY_PROFILE" --wait

# Staple the ticket to the app
echo "üìé Stapling notarization ticket..."
xcrun stapler staple "Samara.app"

# Verify stapling
echo "‚úÖ Verifying notarization..."
spctl -a -v "Samara.app"

# Install
echo "üì≤ Installing to /Applications..."
rm -rf /Applications/Samara.app
cp -R "Samara.app" /Applications/

# Reload launchd agent (this will start the new binary via KeepAlive)
echo "üîÑ Reloading launchd agent..."
launchctl load ~/Library/LaunchAgents/co.organelle.Samara.plist 2>/dev/null || true
sleep 2

# Verify it started
if pgrep -f "Samara.app" > /dev/null 2>&1; then
    echo "üöÄ Samara started successfully via launchd"
else
    # Fallback to direct launch if launchd didn't start it
    echo "‚ö†Ô∏è  launchd didn't start Samara, trying direct launch..."
    open /Applications/Samara.app
    sleep 2
    if pgrep -f "Samara.app" > /dev/null 2>&1; then
        echo "   Samara started successfully"
    else
        echo "‚ö†Ô∏è  Samara may not have started - check logs"
    fi
fi

echo ""
echo "‚úÖ Samara updated and notarized successfully!"
echo ""
echo "FDA should now persist across future rebuilds."
echo ""
