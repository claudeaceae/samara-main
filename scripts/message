#!/bin/bash
# Send an iMessage to collaborator
# Usage: message "Your message here"
#
# Can be called from any context - daemon, direct sessions, autonomous cycles.
# Use for: decision points, questions, discoveries worth sharing, or just saying hi.

set -e
MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"

# Load config (required)
# Note: use subshell test to avoid set -e triggering on first source failure
if [ -f "$MIND_PATH/lib/config.sh" ]; then
    source "$MIND_PATH/lib/config.sh"
elif [ -f "$MIND_PATH/system/lib/config.sh" ]; then
    source "$MIND_PATH/system/lib/config.sh"
else
    echo "Error: config.sh not found" >&2
    exit 1
fi

if [ -z "$COLLABORATOR_PHONE" ]; then
    echo "Error: COLLABORATOR_PHONE not set in config.json" >&2
    exit 1
fi

if [ -z "$1" ]; then
    echo "Usage: message \"Your message here\""
    exit 1
fi

MESSAGE="$1"
PHONE="$COLLABORATOR_PHONE"

# Escape for AppleScript
ESCAPED=$(echo "$MESSAGE" | sed 's/\\/\\\\/g; s/"/\\"/g')

OSASCRIPT_BIN="${OSASCRIPT_BIN:-osascript}"
"$OSASCRIPT_BIN" -e "
    tell application \"Messages\"
        set targetService to 1st account whose service type = iMessage
        set targetBuddy to participant \"$PHONE\" of targetService
        send \"$ESCAPED\" to targetBuddy
    end tell
"

# Log it
LOG_FILE="$MIND_PATH/system/logs/messages-sent.log"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Sent: $MESSAGE" >> "$LOG_FILE"
