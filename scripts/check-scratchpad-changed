#!/bin/bash
# Check if the Claude Scratchpad has been modified by someone OTHER than me
# Uses hash comparison to detect external changes
#
# Exit codes:
#   0 = Changed by someone else (safe to respond)
#   1 = No change, or I made the last change (don't respond)
#   2 = Error

MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"
STATE_DIR="$MIND_PATH/state"
HASH_FILE="$STATE_DIR/scratchpad-hash.txt"
CONTENT_FILE="$STATE_DIR/scratchpad-content.txt"
source "$MIND_PATH/system/lib/config.sh" 2>/dev/null || source "$MIND_PATH/lib/config.sh" 2>/dev/null || true

SCRATCHPAD_PATH="${SCRATCHPAD_FILE:-$MIND_PATH/shared/scratchpad.md}"

if [ "$SHARED_WORKSPACE_SYNC" = "true" ] && [ -d "$SHARED_WORKSPACE_DIR/.git" ]; then
    timeout 10 git -C "$SHARED_WORKSPACE_DIR" pull --ff-only >/dev/null 2>&1 || true
fi

if [ ! -f "$SCRATCHPAD_PATH" ]; then
    echo "ERROR: Scratchpad file not found at $SCRATCHPAD_PATH"
    exit 2
fi

# Get current scratchpad content
CURRENT_CONTENT=$(cat "$SCRATCHPAD_PATH")

# Calculate hash of current content
CURRENT_HASH=$(echo "$CURRENT_CONTENT" | shasum -a 256 | cut -d' ' -f1)

# Check if we have a stored hash
if [[ -f "$HASH_FILE" ]]; then
    STORED_HASH=$(cat "$HASH_FILE")

    if [[ "$CURRENT_HASH" == "$STORED_HASH" ]]; then
        # No change since we last wrote
        echo "No external changes detected"
        exit 1
    else
        # Content changed by someone else!
        echo "External change detected"
        echo "$CURRENT_CONTENT"
        exit 0
    fi
else
    # First run - treat as external change
    echo "First run - no baseline hash"
    echo "$CURRENT_CONTENT"
    exit 0
fi
