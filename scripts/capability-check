#!/bin/bash
# Capability Check - Daily exercise routine for Claude's capabilities
# Runs non-destructively to verify things work and note areas for improvement
#
# Usage: capability-check [--verbose] [--no-alert]
#
# Runs during morning wake cycle (9 AM) via launchd
# Critical failures will message collaborator unless --no-alert is passed
#
# Note: Some tests (Claude CLI, Messages) may fail when run FROM a Claude
# session due to nested invocation limits. They work correctly when run
# from launchd/cron/Terminal.

MIND_PATH="${SAMARA_MIND_PATH:-${MIND_PATH:-$HOME/.claude-mind}}"
OSASCRIPT_BIN="${OSASCRIPT_BIN:-osascript}"
CLAUDE_PATH="${CLAUDE_PATH:-$HOME/.local/bin/claude}"

# Load config (required)
source "$MIND_PATH/system/lib/config.sh" 2>/dev/null || source "$MIND_PATH/system/lib/config.sh" 2>/dev/null || {
    echo "Error: config.sh not found" >&2
    exit 1
}

if [ -z "$COLLABORATOR_PHONE" ]; then
    echo "Error: COLLABORATOR_PHONE not set in config.json" >&2
    exit 1
fi
LOG_FILE="$MIND_PATH/system/logs/capability-check.log"
PASSED=0
FAILED=0
CRITICAL_FAILURES=""

# Parse arguments
VERBOSE=""
NO_ALERT=""
for arg in "$@"; do
    case $arg in
        --verbose) VERBOSE="true" ;;
        --no-alert) NO_ALERT="true" ;;
    esac
done

# Detect if running from within a Claude session
# These env vars are set by Claude Code when it spawns processes
IN_CLAUDE_SESSION=""
if [[ -n "$CLAUDE_CODE_ENTRYPOINT" ]] || [[ -n "$CLAUDE_SESSION_ID" ]] || pgrep -P $$ claude >/dev/null 2>&1; then
    IN_CLAUDE_SESSION="true"
fi

# Start fresh log for this run
echo "" >> "$LOG_FILE"
echo "======================================" >> "$LOG_FILE"

log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$msg" >> "$LOG_FILE"
    [[ -n "$VERBOSE" ]] && echo "$msg"
}

check() {
    local name="$1"
    local cmd="$2"
    local start=$(gdate +%s%N 2>/dev/null || date +%s)

    if result=$(eval "$cmd" 2>&1); then
        local end=$(gdate +%s%N 2>/dev/null || date +%s)
        log "✓ $name"
        PASSED=$((PASSED + 1))
        return 0
    else
        log "✗ $name FAILED"
        if [ -n "$result" ]; then
            log "↳ output: ${result//$'\n'/\\n}"
        fi
        FAILED=$((FAILED + 1))
        return 1
    fi
}

# Critical check - failures will trigger an alert to É
critical_check() {
    local name="$1"
    local cmd="$2"

    if ! check "$name" "$cmd"; then
        CRITICAL_FAILURES="${CRITICAL_FAILURES}• $name\n"
        return 1
    fi
    return 0
}

# Skipped check - for tests that are known to fail in certain contexts
skip_check() {
    local name="$1"
    local reason="$2"
    log "⊘ $name SKIPPED ($reason)"
    SKIPPED=$((SKIPPED + 1))
}

check_with_output() {
    local name="$1"
    local cmd="$2"
    local expected="$3"

    if result=$(eval "$cmd" 2>&1); then
        if [[ -n "$expected" ]] && [[ ! "$result" =~ $expected ]]; then
            log "⚠ $name returned unexpected"
            log "↳ output: ${result//$'\n'/\\n}"
            return 1
        fi
        log "✓ $name"
        return 0
    else
        log "✗ $name FAILED"
        if [ -n "$result" ]; then
            log "↳ output: ${result//$'\n'/\\n}"
        fi
        return 1
    fi
}

echo "=== Capability Check ===" | tee -a "$LOG_FILE"
log "Starting capability check..."
if [[ -n "$IN_CLAUDE_SESSION" ]]; then
    log "Note: Running from Claude session - some tests skipped"
fi

PASSED=0
FAILED=0
SKIPPED=0

# === MEMORY SYSTEM ===
log "--- Memory System ---"

check "Identity file exists" "test -f $MIND_PATH/self/identity.md"
check "Goals file exists" "test -f $MIND_PATH/self/goals.md"
check "Episode dir exists" "test -d $MIND_PATH/memory/episodes"

# === APPLE APPS (Read-only) ===
log "--- Apple Apps (Read-only) ---"

check "Calendar - list calendars" "timeout 10 osascript -e 'tell application \"Calendar\" to count calendars' 2>/dev/null || echo 0"

check "Contacts - query exists" "timeout 10 osascript -e 'tell application \"Contacts\" to count persons' 2>/dev/null || echo 0"

check "Reminders - query exists" "timeout 10 osascript -e 'tell application \"Reminders\" to count lists' 2>/dev/null || echo 0"

# === FILESYSTEM ===
log "--- Filesystem ---"

check "Home dir readable" "ls ~ > /dev/null"
check "Developer dir exists" "test -d ~/Developer"
check "Samara project exists" "test -d ~/Developer/Samara"
check "Scripts executable" "test -x $MIND_PATH/system/bin/wake"

# === NETWORK ===
log "--- Network ---"

check "Internet connectivity" "curl -s --max-time 5 -o /dev/null -w '%{http_code}' https://www.google.com | grep -q 200"
check "Claude API reachable" "curl -s --max-time 5 -o /dev/null -w '%{http_code}' https://api.anthropic.com | grep -qE '(200|401|403|404)'"

# === SAMARA ===
log "--- Samara ---"

check "Samara app exists" "test -d /Applications/Samara.app"
critical_check "Samara running" "pgrep -x Samara > /dev/null"
check "Messages DB exists" "test -f ~/Library/Messages/chat.db"

# Check FDA by looking at Samara logs for database access
# This catches when Samara is running but can't read Messages
critical_check "Samara has FDA (Messages DB access)" "! tail -20 $MIND_PATH/system/logs/samara.log 2>/dev/null | grep -q 'FATAL.*authorization denied'"
check "Samara lock file healthy" "test -f $MIND_PATH/state/samara.lock && lsof $MIND_PATH/state/samara.lock > /dev/null 2>&1"

# === SAMARA UNIT TESTS ===
log "--- Samara Unit Tests ---"
# Run with --quick to skip if tested recently (saves time during frequent wake cycles)
check "Samara unit tests" "$MIND_PATH/system/bin/test-samara --quick 2>&1 | grep -qE 'tests passed|All [0-9]+ tests passed|Skipping'"

# === CLAUDE CLI ===
log "--- Claude CLI ---"

check "Claude CLI exists" "test -x $CLAUDE_PATH"
# Skip invocation test when running from a Claude session (nested invocation not supported)
if [[ -n "$IN_CLAUDE_SESSION" ]]; then
    skip_check "Claude CLI responds" "nested invocation not supported"
else
    check "Claude CLI responds" "timeout 60 $CLAUDE_PATH -p 'respond with just the word OK' --output-format json --model haiku --dangerously-skip-permissions 2>/dev/null | grep -q 'result'"
fi

# === REQUIRED SCRIPTS ===
log "--- Required Scripts ---"

check "wake script" "test -x $MIND_PATH/system/bin/wake"
check "dream script" "test -x $MIND_PATH/system/bin/dream"
critical_check "message-e script" "test -x $MIND_PATH/system/bin/message-e"
critical_check "distill-session script" "test -x $MIND_PATH/system/bin/distill-session"
check "send-image-e script" "test -x $MIND_PATH/system/bin/send-image-e"
check "send-attachment script" "test -x $MIND_PATH/system/bin/send-attachment"
check "screenshot-e script" "test -x $MIND_PATH/system/bin/screenshot-e"
check "bluesky-post script" "test -x $MIND_PATH/system/bin/bluesky-post"
check "bluesky-check script" "test -x $MIND_PATH/system/bin/bluesky-check"
check "log-session script" "test -x $MIND_PATH/system/bin/log-session"
check "distill-claude-session script" "test -x $MIND_PATH/system/bin/distill-claude-session"

# === MESSAGE SENDING (dry run) ===
log "--- Message Sending ---"

# Test that AppleScript for Messages works (without actually sending)
# Skip when running from Claude session as osascript for Messages can hang
if [[ -n "$IN_CLAUDE_SESSION" ]]; then
    skip_check "Messages app scriptable" "osascript hangs in nested session"
else
    check "Messages app scriptable" "timeout 10 osascript -e 'tell application \"Messages\" to count every chat' 2>/dev/null"
fi
check "Pictures staging dir" "mkdir -p $HOME/Pictures/.imessage-send && test -d $HOME/Pictures/.imessage-send"

# === LOCATION ===
log "--- Location ---"

check "Location script exists" "test -x $MIND_PATH/system/bin/get-e-location"
check "Location note readable" "$MIND_PATH/system/bin/get-e-location 2>/dev/null | head -1"

# === SHARED NOTES ===
log "--- Shared Notes ---"

check "Shared workspace dir exists" "test -d \"$SHARED_WORKSPACE_DIR\""
check "Scratchpad readable" "$MIND_PATH/system/bin/check-scratchpad 2>/dev/null | head -1"

# === Summary ===
log "--- Summary ---"
if [[ $SKIPPED -gt 0 ]]; then
    log "Passed: $PASSED | Failed: $FAILED | Skipped: $SKIPPED"
else
    log "Passed: $PASSED | Failed: $FAILED"
fi
log "Capability check complete."

echo ""
if [[ $SKIPPED -gt 0 ]]; then
    echo "Results: ✓ $PASSED passed | ✗ $FAILED failed | ⊘ $SKIPPED skipped"
else
    echo "Results: ✓ $PASSED passed | ✗ $FAILED failed"
fi
echo "Full log: $LOG_FILE"

# === Critical Failure Alert ===
if [[ -n "$CRITICAL_FAILURES" ]]; then
    if [[ -n "$NO_ALERT" ]]; then
        log "CRITICAL FAILURES DETECTED (alerts suppressed with --no-alert)"
        echo "⚠️  Critical failures detected - would alert É in production"
    else
        log "CRITICAL FAILURES DETECTED - alerting É"

        ALERT_MSG="⚠️ Capability check found critical failures:
$(echo -e "$CRITICAL_FAILURES")
Run 'capability-check --verbose' for details."

        # Send alert via AppleScript (bypassing message-e in case it's the failure)
        "$OSASCRIPT_BIN" -e "
            tell application \"Messages\"
                set targetService to 1st account whose service type = iMessage
                set targetBuddy to participant \"$COLLABORATOR_PHONE\" of targetService
                send \"$ALERT_MSG\" to targetBuddy
            end tell
        " >> "$LOG_FILE" 2>&1 || log "Failed to send critical alert (Messages unavailable)"

        log "Critical alert sent"
    fi
fi

# Exit with failure if any checks failed
[[ $FAILED -gt 0 ]] && exit 1
exit 0
