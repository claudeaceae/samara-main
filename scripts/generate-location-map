#!/usr/bin/env python3
"""
Generate map visualizations of location data using Mapbox Static Images API.

Usage:
  generate-location-map --type weekly --output /tmp/weekly-map.png
  generate-location-map --type today --output /tmp/today-map.png
  generate-location-map --type trip <trip_id> --output /tmp/trip-map.png

Requires: Mapbox API token in macOS Keychain (credential set mapbox 'your-token')

To get a token:
1. Sign up at https://account.mapbox.com/auth/signup/
2. Go to https://account.mapbox.com/access-tokens/
3. Copy your default public token
4. Store it: credential set mapbox 'pk.your-token-here'
"""

import argparse
import json
import os
import sys
import urllib.request
import urllib.parse
from datetime import datetime, timedelta
from typing import List, Dict, Optional, Tuple

STATE_DIR = os.path.expanduser("~/.claude-mind/state")
CREDENTIAL_BIN = os.path.expanduser("~/.claude-mind/system/bin/credential")
TRIPS_FILE = os.path.join(STATE_DIR, "trips.jsonl")
HISTORY_FILE = os.path.join(STATE_DIR, "location-history.jsonl")
PLACES_FILE = os.path.join(STATE_DIR, "places.json")

# Mapbox Static Images API
MAPBOX_BASE = "https://api.mapbox.com/styles/v1/mapbox/streets-v12/static"


def load_token() -> Optional[str]:
    """Load Mapbox token from macOS Keychain."""
    import subprocess
    try:
        result = subprocess.run(
            [CREDENTIAL_BIN, 'get', 'mapbox'],
            capture_output=True, text=True
        )
        if result.returncode == 0:
            return result.stdout.strip()
    except Exception:
        pass
    return None


def load_trips(days: int = 7) -> List[Dict]:
    """Load trips from the past N days."""
    if not os.path.exists(TRIPS_FILE):
        return []

    cutoff = datetime.now() - timedelta(days=days)
    trips = []

    with open(TRIPS_FILE) as f:
        for line in f:
            if not line.strip():
                continue
            try:
                trip = json.loads(line)
                start = datetime.fromisoformat(trip['start_time'].replace('Z', '+00:00'))
                if start.replace(tzinfo=None) > cutoff:
                    trips.append(trip)
            except (json.JSONDecodeError, KeyError, ValueError):
                continue

    return trips


def load_trip_by_id(trip_id: str) -> Optional[Dict]:
    """Load a specific trip by ID."""
    if not os.path.exists(TRIPS_FILE):
        return None

    with open(TRIPS_FILE) as f:
        for line in f:
            if not line.strip():
                continue
            try:
                trip = json.loads(line)
                if trip.get('trip_id') == trip_id:
                    return trip
            except json.JSONDecodeError:
                continue

    return None


def load_places() -> List[Dict]:
    """Load known places for markers."""
    if not os.path.exists(PLACES_FILE):
        return []

    with open(PLACES_FILE) as f:
        data = json.load(f)
        return data.get('places', [])


def encode_polyline_for_url(polyline: str) -> str:
    """URL-encode a polyline string."""
    return urllib.parse.quote(polyline, safe='')


def generate_map_url(
    token: str,
    polylines: List[Tuple[str, str]],  # (polyline, color)
    markers: List[Tuple[float, float, str]],  # (lon, lat, color)
    width: int = 800,
    height: int = 600
) -> str:
    """Generate Mapbox Static Images API URL."""
    parts = []

    # Add polylines as paths
    for polyline, color in polylines:
        encoded = encode_polyline_for_url(polyline)
        # path-{strokeWidth}+{strokeColor}-{strokeOpacity}({polyline})
        parts.append(f"path-4+{color}-0.7({encoded})")

    # Add markers
    for lon, lat, color in markers:
        # pin-s+{color}({lon},{lat})
        parts.append(f"pin-s+{color}({lon},{lat})")

    # Combine all overlays
    overlays = ",".join(parts) if parts else ""

    # Use auto to fit all content
    url = f"{MAPBOX_BASE}/{overlays}/auto/{width}x{height}@2x?access_token={token}"

    return url


def download_map(url: str, output_path: str) -> bool:
    """Download map image from URL."""
    try:
        urllib.request.urlretrieve(url, output_path)
        return True
    except urllib.error.HTTPError as e:
        print(f"Error downloading map: {e}", file=sys.stderr)
        if e.code == 401:
            print("Invalid or expired Mapbox token.", file=sys.stderr)
        elif e.code == 422:
            print("Invalid map parameters (possibly empty or too large).", file=sys.stderr)
        return False
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return False


def generate_weekly_map(token: str, output_path: str) -> bool:
    """Generate map of trips from the past week."""
    trips = load_trips(days=7)

    if not trips:
        print("No trips in the past week.", file=sys.stderr)
        return False

    # Collect polylines with different colors for different days
    colors = ["3388ff", "ff6b6b", "4ecdc4", "ffe66d", "95e1d3", "f38181", "aa96da"]
    polylines = []

    for i, trip in enumerate(trips):
        if trip.get('polyline'):
            color = colors[i % len(colors)]
            polylines.append((trip['polyline'], color))

    # Add markers for known places
    places = load_places()
    markers = []
    for place in places:
        if place.get('name') == 'home':
            markers.append((place['lon'], place['lat'], 'ff0000'))
        else:
            markers.append((place['lon'], place['lat'], '00ff00'))

    if not polylines:
        print("No trip polylines available.", file=sys.stderr)
        return False

    url = generate_map_url(token, polylines, markers)
    print(f"Generating weekly map with {len(polylines)} trips...")

    if download_map(url, output_path):
        print(f"Map saved to {output_path}")
        return True
    return False


def generate_today_map(token: str, output_path: str) -> bool:
    """Generate map of today's trips."""
    today = datetime.now().date()
    trips = load_trips(days=1)

    # Filter to just today
    today_trips = []
    for trip in trips:
        try:
            start = datetime.fromisoformat(trip['start_time'].replace('Z', '+00:00'))
            if start.date() == today:
                today_trips.append(trip)
        except (KeyError, ValueError):
            continue

    if not today_trips:
        print("No trips today.", file=sys.stderr)
        return False

    polylines = [(t['polyline'], '3388ff') for t in today_trips if t.get('polyline')]

    places = load_places()
    markers = [(p['lon'], p['lat'], 'ff0000' if p.get('name') == 'home' else '00ff00')
               for p in places]

    if not polylines:
        print("No trip polylines for today.", file=sys.stderr)
        return False

    url = generate_map_url(token, polylines, markers)
    print(f"Generating today's map with {len(polylines)} trips...")

    if download_map(url, output_path):
        print(f"Map saved to {output_path}")
        return True
    return False


def generate_trip_map(token: str, trip_id: str, output_path: str) -> bool:
    """Generate map for a specific trip."""
    trip = load_trip_by_id(trip_id)

    if not trip:
        print(f"Trip not found: {trip_id}", file=sys.stderr)
        return False

    if not trip.get('polyline'):
        print("Trip has no polyline data.", file=sys.stderr)
        return False

    polylines = [(trip['polyline'], '3388ff')]

    # Mark start and end points
    waypoints = trip.get('waypoints', [])
    markers = []
    if waypoints:
        start = waypoints[0]
        end = waypoints[-1]
        markers.append((start['lon'], start['lat'], '00ff00'))  # Green start
        if len(waypoints) > 1:
            markers.append((end['lon'], end['lat'], 'ff0000'))  # Red end

    url = generate_map_url(token, polylines, markers)
    print(f"Generating map for trip {trip_id}...")

    if download_map(url, output_path):
        print(f"Map saved to {output_path}")
        print(f"Trip: {trip.get('start_place', 'unknown')} â†’ {trip.get('end_place', 'unknown')}")
        print(f"Distance: {trip.get('distance_m', 0)}m, Duration: {trip.get('duration_s', 0)//60}min")
        return True
    return False


def main():
    parser = argparse.ArgumentParser(description="Generate location map visualizations")
    parser.add_argument('--type', choices=['weekly', 'today', 'trip'], required=True,
                        help='Type of map to generate')
    parser.add_argument('--trip-id', help='Trip ID (required for --type trip)')
    parser.add_argument('--output', '-o', required=True, help='Output file path')

    args = parser.parse_args()

    # Check for token
    token = load_token()
    if not token:
        print("Mapbox token not found!", file=sys.stderr)
        print(f"\nTo set up Mapbox:", file=sys.stderr)
        print(f"1. Sign up at https://account.mapbox.com/auth/signup/", file=sys.stderr)
        print(f"2. Go to https://account.mapbox.com/access-tokens/", file=sys.stderr)
        print(f"3. Copy your default public token", file=sys.stderr)
        print(f"4. Store it: credential set mapbox 'pk.your_token_here'", file=sys.stderr)
        sys.exit(1)

    # Ensure output directory exists
    output_dir = os.path.dirname(args.output)
    if output_dir:
        os.makedirs(output_dir, exist_ok=True)

    # Generate the requested map
    if args.type == 'weekly':
        success = generate_weekly_map(token, args.output)
    elif args.type == 'today':
        success = generate_today_map(token, args.output)
    elif args.type == 'trip':
        if not args.trip_id:
            print("--trip-id required for --type trip", file=sys.stderr)
            sys.exit(1)
        success = generate_trip_map(token, args.trip_id, args.output)

    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
