{"version":3,"sources":["../src/context.ts","../src/types.ts","../src/utils/validation.ts"],"sourcesContent":["import Conf from 'conf';\nimport { homedir } from 'os';\nimport { join, resolve } from 'path';\nimport type { WizardContext, SavedWizardState, StepName } from './types.js';\n\n// Persistent storage for wizard state\nconst store = new Conf<{ wizardState?: SavedWizardState }>({\n  projectName: 'create-samara',\n});\n\n// State expiry time (24 hours)\nconst STATE_EXPIRY_MS = 24 * 60 * 60 * 1000;\n\nfunction expandTilde(value: string): string {\n  if (value === '~') return homedir();\n  if (value.startsWith('~/')) return join(homedir(), value.slice(2));\n  return value;\n}\n\nfunction resolveMindPath(): string {\n  const override = process.env.SAMARA_MIND_PATH || process.env.MIND_PATH;\n  if (override && override.trim().length > 0) {\n    return resolve(expandTilde(override));\n  }\n  return join(homedir(), '.claude-mind');\n}\n\n/**\n * Create a fresh wizard context\n */\nexport function createContext(): WizardContext {\n  return {\n    config: {},\n    repoPath: process.cwd(),\n    mindPath: resolveMindPath(),\n    hasDeveloperAccount: false,\n    buildFromSource: false,\n    setupBluesky: false,\n    setupGithub: false,\n    completedSteps: new Set(),\n    currentStep: 'welcome',\n  };\n}\n\n/**\n * Load saved wizard state if available and not expired\n */\nexport function loadSavedState(): SavedWizardState | null {\n  const saved = store.get('wizardState');\n\n  if (!saved) return null;\n\n  // Check if expired\n  if (Date.now() - saved.timestamp > STATE_EXPIRY_MS) {\n    store.delete('wizardState');\n    return null;\n  }\n\n  return saved;\n}\n\n/**\n * Restore wizard context from saved state\n */\nexport function restoreFromState(saved: SavedWizardState): WizardContext {\n  return {\n    config: saved.config,\n    repoPath: process.cwd(),\n    mindPath: resolveMindPath(),\n    hasDeveloperAccount: saved.hasDeveloperAccount,\n    buildFromSource: saved.buildFromSource,\n    teamId: saved.teamId,\n    setupBluesky: saved.setupBluesky,\n    setupGithub: saved.setupGithub,\n    completedSteps: new Set(saved.completedSteps),\n    currentStep: saved.currentStep,\n  };\n}\n\n/**\n * Save wizard state for resume capability\n */\nexport function saveState(ctx: WizardContext, step: StepName): void {\n  ctx.completedSteps.add(step);\n  ctx.currentStep = step;\n\n  const state: SavedWizardState = {\n    config: ctx.config,\n    completedSteps: Array.from(ctx.completedSteps),\n    currentStep: step,\n    hasDeveloperAccount: ctx.hasDeveloperAccount,\n    buildFromSource: ctx.buildFromSource,\n    teamId: ctx.teamId,\n    setupBluesky: ctx.setupBluesky,\n    setupGithub: ctx.setupGithub,\n    timestamp: Date.now(),\n  };\n\n  store.set('wizardState', state);\n}\n\n/**\n * Clear saved wizard state (on completion or explicit reset)\n */\nexport function clearState(): void {\n  store.delete('wizardState');\n}\n\n/**\n * Check if a step should be skipped (already completed)\n */\nexport function shouldSkipStep(ctx: WizardContext, step: StepName): boolean {\n  return ctx.completedSteps.has(step);\n}\n\n/**\n * Get the step to resume from\n */\nexport function getResumeStep(saved: SavedWizardState): StepName {\n  // Find the first step that wasn't completed\n  const steps: StepName[] = [\n    'welcome',\n    'identity',\n    'collaborator',\n    'integrations',\n    'birth',\n    'app',\n    'permissions',\n    'launchd',\n    'credentials',\n    'launch',\n    'summary',\n  ];\n\n  for (const step of steps) {\n    if (!saved.completedSteps.includes(step)) {\n      return step;\n    }\n  }\n\n  return 'summary';\n}\n","import { z } from 'zod';\n\n// Entity (Claude's identity) schema\nexport const entitySchema = z.object({\n  name: z.string().min(1).max(50).default('Claude'),\n  icloud: z.string().email('Must be a valid email').refine(\n    (email) => email.endsWith('@icloud.com'),\n    'Must be an iCloud email address'\n  ),\n  bluesky: z.string().regex(/^@[\\w.-]+\\.bsky\\.social$/, 'Must be @handle.bsky.social format').optional(),\n  github: z.string().regex(/^[\\w-]+$/, 'Must be a valid GitHub username').optional(),\n});\n\n// Collaborator (human partner) schema\nexport const collaboratorSchema = z.object({\n  name: z.string().min(1).max(100),\n  phone: z.string().regex(/^\\+[1-9]\\d{1,14}$/, 'Must be E.164 format: +1234567890'),\n  email: z.string().email('Must be a valid email'),\n  bluesky: z.string().regex(/^@[\\w.-]+\\.\\w+$/, 'Must be @handle.domain format').optional(),\n});\n\n// Notes configuration schema\nexport const notesSchema = z.object({\n  location: z.string().default('Claude Location Log'),\n  scratchpad: z.string().default('Claude Scratchpad'),\n});\n\n// Mail configuration schema\nexport const mailSchema = z.object({\n  account: z.string().default('iCloud'),\n});\n\n// Full configuration schema\nexport const configSchema = z.object({\n  entity: entitySchema,\n  collaborator: collaboratorSchema,\n  notes: notesSchema.default({}),\n  mail: mailSchema.default({}),\n});\n\n// Type definitions derived from schemas\nexport type EntityConfig = z.infer<typeof entitySchema>;\nexport type CollaboratorConfig = z.infer<typeof collaboratorSchema>;\nexport type NotesConfig = z.infer<typeof notesSchema>;\nexport type MailConfig = z.infer<typeof mailSchema>;\nexport type SamaraConfig = z.infer<typeof configSchema>;\n\n// Wizard step names for checkpointing\nexport type StepName =\n  | 'welcome'\n  | 'identity'\n  | 'collaborator'\n  | 'integrations'\n  | 'birth'\n  | 'app'\n  | 'permissions'\n  | 'launchd'\n  | 'credentials'\n  | 'launch'\n  | 'summary';\n\n// Wizard context (shared state across steps)\nexport interface WizardContext {\n  // Configuration being built\n  config: Partial<SamaraConfig>;\n\n  // Paths\n  repoPath: string;\n  mindPath: string;\n\n  // Build options\n  hasDeveloperAccount: boolean;\n  buildFromSource: boolean;\n  teamId?: string;\n\n  // Integration selections\n  setupBluesky: boolean;\n  setupGithub: boolean;\n\n  // Progress tracking\n  completedSteps: Set<StepName>;\n  currentStep: StepName;\n}\n\n// Saved wizard state for resume capability\nexport interface SavedWizardState {\n  config: Partial<SamaraConfig>;\n  completedSteps: StepName[];\n  currentStep: StepName;\n  hasDeveloperAccount: boolean;\n  buildFromSource: boolean;\n  teamId?: string;\n  setupBluesky: boolean;\n  setupGithub: boolean;\n  timestamp: number;\n}\n","import { entitySchema, collaboratorSchema } from '../types.js';\n\n/**\n * Validate email format\n */\nexport function isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n/**\n * Validate iCloud email\n */\nexport function isValidICloudEmail(email: string): boolean {\n  return isValidEmail(email) && email.toLowerCase().endsWith('@icloud.com');\n}\n\n/**\n * Validate E.164 phone format\n */\nexport function isValidPhone(phone: string): boolean {\n  const e164Regex = /^\\+[1-9]\\d{1,14}$/;\n  return e164Regex.test(phone);\n}\n\n/**\n * Validate Bluesky handle format\n */\nexport function isValidBlueskyHandle(handle: string): boolean {\n  const blueskyRegex = /^@[\\w.-]+\\.bsky\\.social$/;\n  return blueskyRegex.test(handle);\n}\n\n/**\n * Validate GitHub username format\n */\nexport function isValidGitHubUsername(username: string): boolean {\n  const githubRegex = /^[\\w-]+$/;\n  return githubRegex.test(username);\n}\n\n/**\n * Validate Apple Team ID format\n */\nexport function isValidTeamId(teamId: string): boolean {\n  // Team IDs are 10-character alphanumeric strings\n  const teamIdRegex = /^[A-Z0-9]{10}$/;\n  return teamIdRegex.test(teamId);\n}\n\n/**\n * Format phone number hint\n */\nexport function formatPhoneHint(partial: string): string {\n  if (!partial.startsWith('+')) {\n    return 'Must start with + (e.g., +14155551234)';\n  }\n  if (partial.length < 10) {\n    return 'Enter full number including country code';\n  }\n  return '';\n}\n\n/**\n * Validate entity config\n */\nexport function validateEntity(data: unknown): { success: true; data: unknown } | { success: false; error: string } {\n  const result = entitySchema.safeParse(data);\n  if (result.success) {\n    return { success: true, data: result.data };\n  }\n  return { success: false, error: result.error.errors[0]?.message || 'Invalid entity configuration' };\n}\n\n/**\n * Validate collaborator config\n */\nexport function validateCollaborator(data: unknown): { success: true; data: unknown } | { success: false; error: string } {\n  const result = collaboratorSchema.safeParse(data);\n  if (result.success) {\n    return { success: true, data: result.data };\n  }\n  return { success: false, error: result.error.errors[0]?.message || 'Invalid collaborator configuration' };\n}\n"],"mappings":";AAAA,OAAO,UAAU;AACjB,SAAS,eAAe;AACxB,SAAS,MAAM,eAAe;AAI9B,IAAM,QAAQ,IAAI,KAAyC;AAAA,EACzD,aAAa;AACf,CAAC;AAGD,IAAM,kBAAkB,KAAK,KAAK,KAAK;AAEvC,SAAS,YAAY,OAAuB;AAC1C,MAAI,UAAU,IAAK,QAAO,QAAQ;AAClC,MAAI,MAAM,WAAW,IAAI,EAAG,QAAO,KAAK,QAAQ,GAAG,MAAM,MAAM,CAAC,CAAC;AACjE,SAAO;AACT;AAEA,SAAS,kBAA0B;AACjC,QAAM,WAAW,QAAQ,IAAI,oBAAoB,QAAQ,IAAI;AAC7D,MAAI,YAAY,SAAS,KAAK,EAAE,SAAS,GAAG;AAC1C,WAAO,QAAQ,YAAY,QAAQ,CAAC;AAAA,EACtC;AACA,SAAO,KAAK,QAAQ,GAAG,cAAc;AACvC;AAKO,SAAS,gBAA+B;AAC7C,SAAO;AAAA,IACL,QAAQ,CAAC;AAAA,IACT,UAAU,QAAQ,IAAI;AAAA,IACtB,UAAU,gBAAgB;AAAA,IAC1B,qBAAqB;AAAA,IACrB,iBAAiB;AAAA,IACjB,cAAc;AAAA,IACd,aAAa;AAAA,IACb,gBAAgB,oBAAI,IAAI;AAAA,IACxB,aAAa;AAAA,EACf;AACF;AAKO,SAAS,iBAA0C;AACxD,QAAM,QAAQ,MAAM,IAAI,aAAa;AAErC,MAAI,CAAC,MAAO,QAAO;AAGnB,MAAI,KAAK,IAAI,IAAI,MAAM,YAAY,iBAAiB;AAClD,UAAM,OAAO,aAAa;AAC1B,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAKO,SAAS,iBAAiB,OAAwC;AACvE,SAAO;AAAA,IACL,QAAQ,MAAM;AAAA,IACd,UAAU,QAAQ,IAAI;AAAA,IACtB,UAAU,gBAAgB;AAAA,IAC1B,qBAAqB,MAAM;AAAA,IAC3B,iBAAiB,MAAM;AAAA,IACvB,QAAQ,MAAM;AAAA,IACd,cAAc,MAAM;AAAA,IACpB,aAAa,MAAM;AAAA,IACnB,gBAAgB,IAAI,IAAI,MAAM,cAAc;AAAA,IAC5C,aAAa,MAAM;AAAA,EACrB;AACF;AAKO,SAAS,UAAU,KAAoB,MAAsB;AAClE,MAAI,eAAe,IAAI,IAAI;AAC3B,MAAI,cAAc;AAElB,QAAM,QAA0B;AAAA,IAC9B,QAAQ,IAAI;AAAA,IACZ,gBAAgB,MAAM,KAAK,IAAI,cAAc;AAAA,IAC7C,aAAa;AAAA,IACb,qBAAqB,IAAI;AAAA,IACzB,iBAAiB,IAAI;AAAA,IACrB,QAAQ,IAAI;AAAA,IACZ,cAAc,IAAI;AAAA,IAClB,aAAa,IAAI;AAAA,IACjB,WAAW,KAAK,IAAI;AAAA,EACtB;AAEA,QAAM,IAAI,eAAe,KAAK;AAChC;AAKO,SAAS,aAAmB;AACjC,QAAM,OAAO,aAAa;AAC5B;AAKO,SAAS,eAAe,KAAoB,MAAyB;AAC1E,SAAO,IAAI,eAAe,IAAI,IAAI;AACpC;AAKO,SAAS,cAAc,OAAmC;AAE/D,QAAM,QAAoB;AAAA,IACxB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAEA,aAAW,QAAQ,OAAO;AACxB,QAAI,CAAC,MAAM,eAAe,SAAS,IAAI,GAAG;AACxC,aAAO;AAAA,IACT;AAAA,EACF;AAEA,SAAO;AACT;;;AC7IA,SAAS,SAAS;AAGX,IAAM,eAAe,EAAE,OAAO;AAAA,EACnC,MAAM,EAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,EAAE,EAAE,QAAQ,QAAQ;AAAA,EAChD,QAAQ,EAAE,OAAO,EAAE,MAAM,uBAAuB,EAAE;AAAA,IAChD,CAAC,UAAU,MAAM,SAAS,aAAa;AAAA,IACvC;AAAA,EACF;AAAA,EACA,SAAS,EAAE,OAAO,EAAE,MAAM,4BAA4B,oCAAoC,EAAE,SAAS;AAAA,EACrG,QAAQ,EAAE,OAAO,EAAE,MAAM,YAAY,iCAAiC,EAAE,SAAS;AACnF,CAAC;AAGM,IAAM,qBAAqB,EAAE,OAAO;AAAA,EACzC,MAAM,EAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAAA,EAC/B,OAAO,EAAE,OAAO,EAAE,MAAM,qBAAqB,mCAAmC;AAAA,EAChF,OAAO,EAAE,OAAO,EAAE,MAAM,uBAAuB;AAAA,EAC/C,SAAS,EAAE,OAAO,EAAE,MAAM,mBAAmB,+BAA+B,EAAE,SAAS;AACzF,CAAC;AAGM,IAAM,cAAc,EAAE,OAAO;AAAA,EAClC,UAAU,EAAE,OAAO,EAAE,QAAQ,qBAAqB;AAAA,EAClD,YAAY,EAAE,OAAO,EAAE,QAAQ,mBAAmB;AACpD,CAAC;AAGM,IAAM,aAAa,EAAE,OAAO;AAAA,EACjC,SAAS,EAAE,OAAO,EAAE,QAAQ,QAAQ;AACtC,CAAC;AAGM,IAAM,eAAe,EAAE,OAAO;AAAA,EACnC,QAAQ;AAAA,EACR,cAAc;AAAA,EACd,OAAO,YAAY,QAAQ,CAAC,CAAC;AAAA,EAC7B,MAAM,WAAW,QAAQ,CAAC,CAAC;AAC7B,CAAC;;;ACjCM,SAAS,aAAa,OAAwB;AACnD,QAAM,aAAa;AACnB,SAAO,WAAW,KAAK,KAAK;AAC9B;AAKO,SAAS,mBAAmB,OAAwB;AACzD,SAAO,aAAa,KAAK,KAAK,MAAM,YAAY,EAAE,SAAS,aAAa;AAC1E;AAKO,SAAS,aAAa,OAAwB;AACnD,QAAM,YAAY;AAClB,SAAO,UAAU,KAAK,KAAK;AAC7B;AAKO,SAAS,qBAAqB,QAAyB;AAC5D,QAAM,eAAe;AACrB,SAAO,aAAa,KAAK,MAAM;AACjC;AAKO,SAAS,sBAAsB,UAA2B;AAC/D,QAAM,cAAc;AACpB,SAAO,YAAY,KAAK,QAAQ;AAClC;AAKO,SAAS,cAAc,QAAyB;AAErD,QAAM,cAAc;AACpB,SAAO,YAAY,KAAK,MAAM;AAChC;AAKO,SAAS,gBAAgB,SAAyB;AACvD,MAAI,CAAC,QAAQ,WAAW,GAAG,GAAG;AAC5B,WAAO;AAAA,EACT;AACA,MAAI,QAAQ,SAAS,IAAI;AACvB,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAKO,SAAS,eAAe,MAAqF;AAClH,QAAM,SAAS,aAAa,UAAU,IAAI;AAC1C,MAAI,OAAO,SAAS;AAClB,WAAO,EAAE,SAAS,MAAM,MAAM,OAAO,KAAK;AAAA,EAC5C;AACA,SAAO,EAAE,SAAS,OAAO,OAAO,OAAO,MAAM,OAAO,CAAC,GAAG,WAAW,+BAA+B;AACpG;AAKO,SAAS,qBAAqB,MAAqF;AACxH,QAAM,SAAS,mBAAmB,UAAU,IAAI;AAChD,MAAI,OAAO,SAAS;AAClB,WAAO,EAAE,SAAS,MAAM,MAAM,OAAO,KAAK;AAAA,EAC5C;AACA,SAAO,EAAE,SAAS,OAAO,OAAO,OAAO,MAAM,OAAO,CAAC,GAAG,WAAW,qCAAqC;AAC1G;","names":[]}